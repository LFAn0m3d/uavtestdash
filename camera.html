<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WAR ROOM ‚Äî Camera Detections</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg:#0f1720;        /* page background */
      --panel:#111417;     /* panel background */
      --muted:#9aa7b9;     /* secondary text */
      --text:#e6eef8;      /* main text */
      --primary:#2b6cb0;   /* flat primary (muted blue) */
      --accent:#7f7f7f;    /* neutral accent */
      --btn-text:#ffffff;  /* button text */
      --border:#1f2933;    /* subtle border */
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.6 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;height:100vh;display:flex;flex-direction:column}
    #map{flex:1}
    .topbar{
      display:flex;align-items:center;gap:12px;
      background:var(--panel);
      color:var(--text);padding:12px 14px;
      border-bottom:2px solid var(--border);
      font-weight:700;
    }
    .topbar > div:first-child{font-weight:800;letter-spacing:1px}
    .chip{background:transparent;border:1px solid var(--border);padding:6px 10px;border-radius:6px;font-size:12px;color:var(--muted)}
    /* Large, flat button used across UI */
    .btn{background:var(--primary);border:none;color:var(--btn-text);padding:10px 14px;border-radius:8px;cursor:pointer;text-decoration:none;font-weight:700;font-size:13px;letter-spacing:0.3px;box-shadow:0 2px 0 rgba(0,0,0,0.35);transition:transform .12s ease, box-shadow .12s ease}
    .btn:hover{transform:translateY(-2px)}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
    .ws{margin-left:12px;font-size:12px;color:var(--muted);letter-spacing:0.4px;display:flex;align-items:center}
    .lamp{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:8px;background:#6b7280;transition:background .12s, box-shadow .12s}
    .lamp.connected{background:#16a34a;box-shadow:0 0 8px rgba(22,163,74,0.6)}
    .lamp.connecting{background:#f59e0b;box-shadow:0 0 6px rgba(245,158,11,0.4)}
    .lamp.error{background:#dc2626;box-shadow:0 0 8px rgba(220,38,38,0.6)}
    .legend{position:absolute;bottom:10px;left:10px;background:var(--panel);padding:8px 12px;border-radius:6px;font-size:12px;color:var(--muted);border:1px solid var(--border);font-weight:700;letter-spacing:1px}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px}
    .dot.red{background:#ff0055}
  </style>
</head>
<body>
  <div class="topbar">
    <div>‚öîÔ∏è WAR ROOM ‚Äî DEFENSE </div>
    <div class="chip">üé• Hostile/Unknown Detection Stream</div>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <button class="btn" onclick="centerAll()">‚äï Center View</button>
      <a class="btn" href="./index.html"> üìä Dashboard</a>
      <a class="btn" href="./offense.html" title="Offensive Units">Offense</a>
    </div>

    <div class="ws">
      <span id="liveTime" style="font-family:monospace;font-weight:700;margin-right:12px">--:--:--</span>
      <i id="lamp" class="lamp"></i><span id="wst">OFFLINE</span>
    </div>
  </div>

  <div id="map"></div>
  <div class="legend">
    <div><span class="dot red"></span>Detection Point (Camera)</div>
    <div style="margin-top:6px;">üõ∏ Attack Drone (Real-time)</div>
    <div style="margin-top:6px;">üî∫ Trajectory (Last 20 points)</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ----------------------------
    // INITIAL MAP
    // ----------------------------
    const map = L.map('map').setView([14.296422,101.166061], 12); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ (‡∏ã‡∏π‡∏°‡πÉ‡∏Å‡∏•‡πâ)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19,
      attribution:'&copy; OpenStreetMap'
    }).addTo(map);


    const detLayer = L.layerGroup().addTo(map);
    const trajectoryLayer = L.layerGroup().addTo(map);
    const droneLayer = L.layerGroup().addTo(map);
    let detections = [];
    let routes = {}; // { droneId: [ {lat,lon,ts}, ... ] }
    let attackDrones = {}; // { droneId: {lat, lon, battery, signal, velocity, altitude, heading} }

    // Live clock update
    function updateLiveClock() {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, '0');
      const mm = String(now.getMinutes()).padStart(2, '0');
      const ss = String(now.getSeconds()).padStart(2, '0');
      document.getElementById('liveTime').textContent = `${hh}:${mm}:${ss}`;
    }
    updateLiveClock();
    setInterval(updateLiveClock, 1000);

    // Camera marker at center
    const cameraIcon = L.divIcon({
      html: `<div style="width:32px;height:32px;background:linear-gradient(135deg,rgba(0,255,200,.3),rgba(0,200,255,.3));border:2px solid #00ffc8;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 0 16px rgba(0,255,200,.6),inset 0 0 8px rgba(0,255,200,.3);font-size:18px">üìπ</div>`,
      className: 'camera-icon',
      iconSize: [32, 32],
      iconAnchor: [16, 16]
    });
    L.marker([14.296422,101.166061], {icon: cameraIcon}).bindTooltip('üé• CAMERA_01', {permanent: true, direction: 'top', offset: [0, -10], className: 'drone-label'}).addTo(map);

    const lamp = document.getElementById('lamp');
    const wst = document.getElementById('wst');

    function setWsUI(state){
      // unify with other pages: toggle classes for .lamp
      lamp.classList.remove('connected','connecting','error');
      if(state==='OPEN'){ lamp.classList.add('connected'); wst.textContent='CONNECTED'; }
      else if(state==='CONNECTING'){ lamp.classList.add('connecting'); wst.textContent='CONNECTING...'; }
      else if(state==='ERROR'){ lamp.classList.add('error'); wst.textContent='ERROR'; }
      else { wst.textContent='DISCONNECTED'; }
    }

    function redraw(){
      detLayer.clearLayers();
      trajectoryLayer.clearLayers();
      droneLayer.clearLayers();
      
      // Show detection points (red circles)
      detections.forEach(d=>{
        const circle = L.circleMarker([d.lat,d.lon],{
          radius:8,color:'#ff0055',fillColor:'#ff4444',fillOpacity:0.8,weight:2
        });
        
        const heading = d.heading || 0;
        const altitude = (d.altitude || 0).toFixed(0);
        const tooltipText = `<div style="font-family:monospace;font-size:11px">
          <b>${d.drone_id || 'Unknown'}</b><br>
          Detection Point<br>
          Direction: ${heading.toFixed(0)}¬∞<br>
          Altitude: ${altitude}m<br>
          Confidence: ${d.confidence || 0}
        </div>`;
        
        circle.bindTooltip(tooltipText, {permanent: false, className: 'drone-label'});
        circle.addTo(detLayer);
      });
      
      // Draw trajectories from routes
      Object.entries(routes).forEach(([droneId, points]) => {
        if(points.length < 2) return;
        
        const latlngs = points.slice(-20).map(p => [p.lat, p.lon]); // last 20 points
        const polyline = L.polyline(latlngs, {
          color: '#ff6699',
          weight: 2,
          opacity: 0.6,
          dashArray: '5,5'
        }).addTo(trajectoryLayer);
        
        // Add direction arrow at latest point
        const last = points[points.length - 1];
        const secondLast = points[points.length - 2] || points[points.length - 1];
        const bearing = Math.atan2(
          last.lon - secondLast.lon,
          last.lat - secondLast.lat
        ) * 180 / Math.PI;
        
        const arrowIcon = L.divIcon({
          html: `<div style="transform:rotate(${bearing}deg);font-size:24px">üî∫</div>`,
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });
        L.marker([last.lat, last.lon], {icon: arrowIcon}).addTo(trajectoryLayer);
      });
      
      // Show attack drones (current position with threat indicator)
      Object.entries(attackDrones).forEach(([droneId, drone]) => {
        const droneIcon = L.divIcon({
          html: `<div style="
            width:28px;height:28px;
            background:radial-gradient(circle, #ff3333, #cc0000);
            border:2px solid #ff0055;
            border-radius:4px;
            display:flex;align-items:center;justify-content:center;
            box-shadow:0 0 12px rgba(255,51,51,0.8);
            font-size:16px;
            transform:rotate(${drone.heading || 0}deg);
          ">üõ∏</div>`,
          iconSize: [28, 28],
          iconAnchor: [14, 14]
        });
        
        const batteryColor = drone.battery > 70 ? '#4ade80' : drone.battery > 40 ? '#facc15' : '#ff6b6b';
        const signalColor = drone.signal > 80 ? '#4ade80' : drone.signal > 50 ? '#facc15' : '#ff6b6b';
        
        const tooltipText = `<div style="font-family:monospace;font-size:11px;color:#fff">
          <b style="color:#ff3333">${droneId}</b><br>
          <span style="color:${batteryColor}">üîã Battery: ${drone.battery.toFixed(0)}%</span><br>
          <span style="color:${signalColor}">üì° Signal: ${drone.signal.toFixed(0)}%</span><br>
          ‚úà Velocity: ${drone.velocity.toFixed(1)} m/s<br>
          üìç Altitude: ${drone.altitude.toFixed(0)}m<br>
          üß≠ Heading: ${drone.heading.toFixed(0)}¬∞
        </div>`;
        
        const marker = L.marker([drone.lat, drone.lon], {icon: droneIcon});
        marker.bindTooltip(tooltipText, {permanent: false, className: 'drone-label'});
        marker.addTo(droneLayer);
      });
    }

    function centerAll(){
      if(detections.length===0) return;
      const latlngs = detections.map(d=>[d.lat,d.lon]);
      if(latlngs.length > 0) map.fitBounds(latlngs,{padding:[30,30]});
    }

    // ----------------------------
    // WEBSOCKET
    // ----------------------------
    const url = localStorage.getItem('warroom:ws') || 'ws://localhost:8765/stream';
    let retry=0;
    function openWs(){
      setWsUI('CONNECTING');
      const ws = new WebSocket(url);
      ws.onopen = ()=>{ retry=0; setWsUI('OPEN'); };
      ws.onerror = ()=> setWsUI('ERROR');
      ws.onclose = ()=>{
        setWsUI('DISCONNECTED');
        const wait = Math.min(15000, 1000*(2**retry++));
        console.log(`Reconnecting in ${wait/1000}s`);
        setTimeout(openWs, wait);
      };
      ws.onmessage = ev=>{
        try{
          const msg = JSON.parse(ev.data);
          
          // Track attack drone routes and current position
          if(msg.type==='route_point' && msg.data && msg.data.role==='attack'){
            const d = msg.data;
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏î‡∏£‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏à‡∏°‡∏ï‡∏µ
            attackDrones[d.drone_id] = {
              lat: +d.lat,
              lon: +d.lon,
              battery: +(d.battery ?? 50),
              signal: +(d.signal ?? 50),
              velocity: +(d.velocity ?? 0),
              altitude: +(d.altitude ?? 0),
              heading: +(d.heading ?? 0),
              ts: d.ts
            };
            
            // Track trajectory
            if(!routes[d.drone_id]) routes[d.drone_id] = [];
            routes[d.drone_id].push({
              lat: +d.lat,
              lon: +d.lon,
              ts: d.ts,
              heading: d.heading,
              altitude: d.altitude
            });
            if(routes[d.drone_id].length > 50) routes[d.drone_id].shift(); // keep last 50
            
            redraw();
          }
          
          // Show detections with full data
          if(msg.type==='detection' && msg.data){
            const d = msg.data;
            detections.unshift({
              lat: +d.lat,
              lon: +d.lon,
              confidence: +(d.confidence??0),
              raw_type: d.raw_type||'unknown',
              drone_id: d.drone_id || 'Unknown',
              heading: d.heading || 0,
              altitude: d.altitude || 0
            });
            if(detections.length>10) detections.length=10; // ‡πÄ‡∏Å‡πá‡∏ö 10 ‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            redraw();
          }
        }catch(e){ console.warn('Bad message', e); }
      };
    }
    openWs();
  </script>
</body>
</html>
