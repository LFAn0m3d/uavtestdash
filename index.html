<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WAR ROOM ‚Äî Tactical Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root{
    --bg:#0f1720;
    --panel:#111417;
    --text:#e6eef8;
    --muted:#9aa7b9;
    --primary:#2b6cb0;
    --accent:#6b7280;
    --border:#1f2933
  }
  *{box-sizing:border-box}
  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:15px/1.6 'Segoe UI','Helvetica Neue',Arial,sans-serif
  }
  body::before{
    content:'';
    position:fixed;
    top:0;left:0;right:0;bottom:0;
    pointer-events:none;
    z-index:1
  }
  .header{
    background:var(--panel);
    padding:14px 16px;
    border-bottom:2px solid var(--border);
    position:relative;
    z-index:2
  }
  .header h2{letter-spacing:1px}
  .small{color:var(--muted);font-size:13px}
  .wrap{
    display:grid;
    grid-template-columns:2fr 0.9fr 1fr;
    gap:14px;
    padding:14px;
    position:relative;
    z-index:2
  }
  .panel{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:10px;
    padding:14px;
    backdrop-filter:none;
    box-shadow:0 1px 0 rgba(0,0,0,.4)
  }
  .panel h3{
    color:var(--text);
    letter-spacing:0.4px;
    margin:0 0 10px 0
  }
  .btn{
    background:var(--primary);
    border:none;
    color:#fff;
    padding:12px 18px;
    border-radius:8px;
    text-decoration:none;
    display:inline-block;
    cursor:pointer;
    font-weight:700;
    font-size:14px;
    letter-spacing:0.3px;
    transition:transform .12s, box-shadow .12s
  }
  .btn.secondary{
    background:transparent;
    color:var(--muted);
    border:1px solid var(--border)
  }
  .btn:active{transform:translateY(1px)}
  .lamp{
    display:inline-block;
    width:10px;height:10px;
    border-radius:50%;
    background:#444;
    margin:0 8px
  }
  /* status lamp states (connected / connecting / error) */
  .lamp.on,.lamp.connected{
    background:#16a34a;
    box-shadow:0 0 8px rgba(22,163,74,0.6)
  }
  .lamp.connecting{
    background:#f59e0b;
    box-shadow:0 0 6px rgba(245,158,11,0.4)
  }
  .lamp.err,.lamp.error{
    background:#dc2626;
    box-shadow:0 0 8px rgba(220,38,38,0.6)
  }
  @keyframes droneFloat {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-3px); }
  }
  .drone-float { animation: droneFloat 2s ease-in-out infinite; }
  /* Map sizing */
  #map{
    height:72vh;
    border:1px solid var(--border);
    border-radius:8px;
    background:var(--panel);
    box-shadow:0 1px 0 rgba(0,0,0,.4)
  }
  .threat-wrap{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:16px;
    padding:6px 0 18px
  }
  .threat-gauge{
    width:220px;
    height:220px;
    border-radius:50%;
    position:relative;
    background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.08), rgba(239,68,68,0.12) 55%, rgba(239,68,68,0.4) 100%);
    border:6px solid rgba(239,68,68,0.9);
    box-shadow:0 0 28px rgba(239,68,68,0.45), inset 0 0 30px rgba(0,0,0,0.6);
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    overflow:hidden
  }
  .threat-gauge::before{
    content:'';
    position:absolute;
    inset:12px;
    border-radius:50%;
    background:radial-gradient(circle, rgba(0,0,0,0.65), rgba(0,0,0,0.85));
    box-shadow:0 0 24px rgba(239,68,68,0.55);
    z-index:0
  }
  .threat-gauge .gauge-label{
    position:relative;
    z-index:1;
    display:flex;
    flex-direction:column;
    gap:6px;
    font-family:"Orbitron", "Segoe UI", sans-serif
  }
  .threat-gauge .gauge-label span{
    font-size:14px;
    letter-spacing:3px;
    color:rgba(255,255,255,0.7)
  }
  .threat-gauge .gauge-label strong{
    font-size:28px;
    letter-spacing:1px;
    color:#ff6464;
    text-shadow:0 0 14px rgba(255,100,100,0.8), 0 0 4px rgba(0,0,0,0.7)
  }
  .threat-meta{
    width:100%;
    display:grid;
    grid-template-columns:repeat(2, minmax(0,1fr));
    gap:12px;
    text-transform:uppercase;
    font-size:12px;
    letter-spacing:1px;
    text-align:center
  }
  .threat-meta .label{color:var(--muted);font-size:11px;display:block;margin-bottom:4px}
  .threat-meta .value{
    font-size:20px;
    font-weight:800;
    text-shadow:0 0 10px rgba(0,0,0,0.6)
  }
  .threat-meta .value.red{color:#ff4d4f}
  .threat-meta .value.white{color:#fff}
  .btn.alert{
    background:linear-gradient(135deg,#f87171 0%,#dc2626 60%,#7f1d1d 100%);
    box-shadow:0 0 18px rgba(248,113,113,0.35);
    font-size:15px;
    letter-spacing:1px;
    padding:14px 22px
  }
  .btn.alert:hover{box-shadow:0 0 22px rgba(248,113,113,0.55)}
  .panel-subtitle{
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.6px;
    margin:4px 0 10px;
    color:var(--muted);
    display:flex;
    align-items:center;
    gap:8px
  }
  .track-list{
    display:grid;
    gap:12px
  }
  .track-card{
    position:relative;
    border:1px solid rgba(59,130,246,0.15);
    border-radius:12px;
    padding:14px;
    background:linear-gradient(135deg, rgba(30,64,175,0.35) 0%, rgba(17,24,39,0.75) 100%);
    box-shadow:0 8px 18px rgba(15,23,42,0.45);
    overflow:hidden
  }
  .track-card::after{
    content:'';
    position:absolute;
    inset:0;
    border-radius:12px;
    border:1px solid rgba(96,165,250,0.12);
    pointer-events:none
  }
  .track-card header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px
  }
  .track-id{
    font-size:16px;
    font-weight:800;
    letter-spacing:1px;
    color:#93c5fd
  }
  .track-role{
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:1.4px;
    padding:4px 8px;
    border-radius:999px;
    background:rgba(148,163,184,0.2);
    color:#e2e8f0
  }
  .track-role.friendly{background:rgba(34,197,94,0.22);color:#bbf7d0}
  .track-role.hostile{background:rgba(239,68,68,0.25);color:#fecaca}
  .track-coords{
    font-family:monospace;
    font-size:12px;
    color:rgba(226,232,240,0.72);
    margin-bottom:12px
  }
  .track-metrics{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:10px;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:0.8px
  }
  .track-metrics span{
    display:block;
    color:rgba(148,163,184,0.9)
  }
  .track-metrics strong{
    display:block;
    font-size:15px;
    color:#f8fafc;
    margin-top:2px
  }
  .track-actions{
    margin-top:14px;
    display:flex;
    justify-content:flex-end
  }
  .event-log{
    background:rgba(15,23,42,0.6);
    border:1px solid rgba(148,163,184,0.16);
    border-radius:10px;
    padding:12px;
    max-height:260px;
    overflow-y:auto;
    font-family:monospace;
    font-size:12px
  }
  .log-entry{
    display:flex;
    gap:10px;
    margin-bottom:8px;
    align-items:flex-start
  }
  .log-entry:last-child{margin-bottom:0}
  .log-time{color:rgba(148,163,184,0.75);min-width:90px}
  .log-msg{color:#cbd5f5;line-height:1.4}
  .log-entry.critical .log-msg{color:#fca5a5}
  .log-entry.success .log-msg{color:#a7f3d0}
  .log-entry.info .log-msg{color:#bae6fd}
</style>
</head>
<body>
  <div class="header">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
      <div>
        <h2 style="margin:0">WAR ROOM ‚Äî Tactical Command Dashboard</h2>
        <div class="small">
          Mission: <b id="missionNameLabel">Operation Sentinel</b>
          ‚Ä¢ Status: <b style="color:#9bff99">ACTIVE</b>
          ‚Ä¢ WS: <i id="wsLamp" class="lamp"></i><span id="wsState">DISCONNECTED</span>
          ‚Ä¢ Time: <b id="liveTime" style="font-family:monospace">--:--:--</b>
        </div>
      </div>
      <div class="nav" style="display:flex;gap:8px">
        <a class="btn" href="./controls.html">Controls</a>
        <a class="btn" href="./defense-camera.html" title="Defense Camera">üõ°Ô∏è Defense</a>
        <a class="btn" href="./offense.html" title="‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏î‡∏£‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏£‡∏∏‡∏Å">Offense view</a>
        <a class="btn" href="./camera.html" title="‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á">Camera view</a>
        <a class="btn" href="./imagery.html" title="Image Viewer">üìπ Imagery</a>
        <a class="btn" href="./history.html" title="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö">History</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <h3 style="margin:0 0 8px">Tactical Map</h3>
      <div id="map"></div>
    </div>
    <div class="panel">
      <h3 style="margin:0 0 8px">THREAT LEVEL</h3>
      <div class="threat-wrap">
        <div class="threat-gauge">
          <div class="gauge-label">
            <span>THREAT LEVEL</span>
            <strong>ALERTCON 1</strong>
          </div>
        </div>
        <div class="threat-meta">
          <div>
            <span class="label">Active Detections</span>
            <span class="value red" id="threatDetections">6</span>
          </div>
          <div>
            <span class="label">Active Tracks</span>
            <span class="value white" id="threatTracks">6</span>
          </div>
        </div>
        <button class="btn alert" id="ackAlertBtn">[ ACKNOWLEDGE ALERT ]</button>
      </div>
      <div style="width:100%;margin-top:8px">
        <div class="panel-subtitle">Event Log</div>
        <div class="event-log" id="eventLog">‚Äî</div>
      </div>
    </div>
    <div class="panel">
      <h3 style="margin:0 0 8px">PRIORITY TRACKS</h3>
      <div class="track-list" id="priorityTracks">‚Äî</div>
    </div>
  </div>

<script>
/* ===================== CONFIG & STATE ===================== */
const START = [14.296422,101.166061];

const wsURL = localStorage.getItem('warroom:ws') || 'ws://localhost:8765/stream';

const maxPoints = 10; // ‡∏•‡πá‡∏≠‡∏Å 10 ‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤

// Live clock update
function updateLiveClock() {
  const now = new Date();
  const hh = String(now.getHours()).padStart(2, '0');
  const mm = String(now.getMinutes()).padStart(2, '0');
  const ss = String(now.getSeconds()).padStart(2, '0');
  document.getElementById('liveTime').textContent = `${hh}:${mm}:${ss}`;
}
updateLiveClock();
setInterval(updateLiveClock, 1000);
let missionName = localStorage.getItem('warroom:mission') || 'Operation Sentinel';

let detections = JSON.parse(localStorage.getItem('warroom:detections')||'[]');
let routes = JSON.parse(localStorage.getItem('warroom:routes')||'[]');
let nextDetId = (detections.reduce((m,d)=>Math.max(m,d.id||0),0) || 0) + 1;

function saveState(){
  localStorage.setItem('warroom:mission', missionName);
  localStorage.setItem('warroom:detections', JSON.stringify(detections));
  localStorage.setItem('warroom:routes', JSON.stringify(routes));
}

document.getElementById('missionNameLabel').textContent = missionName;

/* ===================== MAP ===================== */
const map = L.map('map').setView(START, 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,
  attribution:'&copy; OpenStreetMap'
}).addTo(map);


const detLayer = L.layerGroup().addTo(map);
const routeLineLayer = L.layerGroup().addTo(map);
const arrowLayer = L.layerGroup().addTo(map);

// Camera marker at center
const cameraIcon = L.divIcon({
  html: `<div style="width:32px;height:32px;background:linear-gradient(135deg,rgba(0,255,200,.3),rgba(0,200,255,.3));border:2px solid #00ffc8;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 0 16px rgba(0,255,200,.6),inset 0 0 8px rgba(0,255,200,.3);font-size:18px">üìπ</div>`,
  className: 'camera-icon',
  iconSize: [32, 32],
  iconAnchor: [16, 16]
});
L.marker(START, {icon: cameraIcon})
  .bindTooltip('üé• CAMERA_01 (Fixed)', {
    permanent: true,
    direction: 'top',
    offset: [0, -10],
    className: 'drone-label'
  })
  .addTo(map)
  .openTooltip();

/* ===================== ROLE COLORS ===================== */
function getRole(id, routes){
  // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ role ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• routes ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
  for(let r of routes){
    if(r.drone_id === id && r.role) return r.role;
  }
  // fallback: role ‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏π‡πà‡∏Ñ‡∏µ‡πà‡∏Ç‡∏≠‡∏á ID
  const m = String(id||'').match(/(\d+)$/);
  return (m && (parseInt(m[1],10)%2===1)) ? 'offense' : 'defense';
}
function roleColor(role){
  return role==='offense' || role==='friendly' ? '#34d399' : '#ff6699';
}

/* ===================== DEDUP & HISTORY ===================== */
const seen = new Set(); // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡∏ï‡πà‡∏≠ session
function dedupKey(d){
  return `${d.source_id||''}:${(+d.lat).toFixed(5)},${(+d.lon).toFixed(5)},${new Date(d.ts).getTime()}`;
}

function pushHistoryDet(d){
  try{
    const key='warroom:history:detections';
    const cur = JSON.parse(localStorage.getItem(key)||'[]');
    cur.unshift(d);
    const MAX=5000;
    if(cur.length>MAX) cur.length=MAX;
    // purge ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤ 7 ‡∏ß‡∏±‡∏ô
    const cutoff = Date.now()-7*24*60*60*1000;
    const pruned = cur.filter(x => new Date(x.ts).getTime() >= cutoff);
    localStorage.setItem(key, JSON.stringify(pruned));
  }catch{}
}

function keepRecentDetections(limit=10){
  const sorted = detections.slice().sort((a,b)=>new Date(b.ts)-new Date(a.ts));
  const recent = sorted.slice(0, limit);
  const overflow = sorted.slice(limit);
  overflow.forEach(pushHistoryDet);
  detections = recent;
}

/* ===================== INGEST ===================== */
function pushDet(x){
  const lat=Number(x.lat), lon=Number(x.lon);
  if(!Number.isFinite(lat)||!Number.isFinite(lon)) return;
  const d = {
    id: nextDetId++,
    source_id: x.source_id || 'rt',
    lat, lon,
    ts: x.ts || new Date().toISOString(),
    confidence: x.confidence!==undefined ? Number(x.confidence) : null,
    raw_type: x.raw_type || 'unknown'
  };
  const k = dedupKey(d);
  if (seen.has(k)) return;
  seen.add(k);
  detections.push(d);
}

function pushRoute(x){
  if(!x||!x.drone_id) return;
  const lat=Number(x.lat), lon=Number(x.lon);
  if(!Number.isFinite(lat)||!Number.isFinite(lon)) return;
  const role = x.role || (x.raw_type && x.raw_type.includes('attack')
               ? 'attack'
               : (x.role==='friendly' ? 'friendly' : (x.role||'unknown')));

  routes.push({
    drone_id:String(x.drone_id),
    seq:x.seq!==undefined? parseInt(x.seq,10): undefined,
    lat, lon,
    ts:x.ts||undefined,
    battery: x.battery !== undefined ? Number(x.battery) : null,
    signal: x.signal !== undefined ? Number(x.signal) : null,
    velocity: x.velocity !== undefined ? Number(x.velocity) : null,
    altitude: x.altitude !== undefined ? Number(x.altitude) : null,
    status: x.status || 'active',
    role: role
  });

  // limit routes length ‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ß‡∏°‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
  if (routes.length > 2000) routes.shift();
}

/* ===================== RENDER ===================== */
function fmtTime(s){
  try{ return new Date(s).toLocaleString(); }
  catch{ return s||''; }
}

function fmtLogTime(s){
  try{
    return new Date(s).toLocaleTimeString('en-GB', {hour12:false});
  }catch{
    return '--:--:--';
  }
}

function trackDrone(droneId){
  // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏î‡∏£‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å routes
  const droneRoutes = routes.filter(r => r.drone_id === droneId);
  if(droneRoutes.length === 0) return;
  
  const lastRoute = droneRoutes[droneRoutes.length - 1];
  const lat = lastRoute.lat;
  const lon = lastRoute.lon;
  
  // zoom ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏£‡∏ô‡∏ô‡∏±‡πâ‡∏ô
  map.setView([lat, lon], 14, { animate: true, duration: 1 });
}

function redraw(){
  const threatDetEl = document.getElementById('threatDetections');
  const threatTracksEl = document.getElementById('threatTracks');
  const eventLogEl = document.getElementById('eventLog');
  const trackListEl = document.getElementById('priorityTracks');

  if(threatDetEl){
    threatDetEl.textContent = String(detections.length);
  }
  if(threatTracksEl){
    const uniqueDrones = Array.from(new Set(routes.map(r=>r.drone_id)));
    threatTracksEl.textContent = String(uniqueDrones.length);
  }

  // Drones list grouped by id
  const byId = new Map();
  routes.forEach(r => {
    if(!byId.has(r.drone_id)) byId.set(r.drone_id, []);
    byId.get(r.drone_id).push(r);
  });

  const drones = Array.from(byId.entries())
    .map(([id,arr])=>{
      const last = arr.slice().sort((a,b)=>(a.seq||0)-(b.seq||0)).pop();
      const role = last?.role || getRole(id, arr);
      return {
        id,
        role,
        lat:last?.lat,
        lon:last?.lon,
        ts:last?.ts,
        seq:last?.seq,
        battery: last?.battery,
        signal: last?.signal,
        velocity: last?.velocity,
        altitude: last?.altitude,
        status: last?.status
      };
    });

  if(trackListEl){
    const prioritized = drones.slice()
      .sort((a,b)=>{
        const at = a.ts ? new Date(a.ts).getTime() : 0;
        const bt = b.ts ? new Date(b.ts).getTime() : 0;
        return bt - at || String(a.id).localeCompare(b.id);
      })
      .slice(0,6);

    trackListEl.innerHTML = prioritized.map(d=>{
      const lat = Number.isFinite(Number(d.lat)) ? Number(d.lat).toFixed(5) : '-';
      const lon = Number.isFinite(Number(d.lon)) ? Number(d.lon).toFixed(5) : '-';
      const velocityNum = Number(d.velocity);
      const altitudeNum = Number(d.altitude);
      const batteryNum = Number(d.battery);
      const signalNum = Number(d.signal);
      const velocity = Number.isFinite(velocityNum) ? `${velocityNum.toFixed(1)} m/s` : '--';
      const altitude = Number.isFinite(altitudeNum) ? `${altitudeNum.toFixed(0)} m` : '--';
      const battery = Number.isFinite(batteryNum) ? `${batteryNum.toFixed(0)}%` : '--';
      const signal = Number.isFinite(signalNum) ? `${signalNum.toFixed(0)}%` : '--';
      const roleLabel = (d.role || 'unknown').replace(/_/g,' ').toUpperCase();
      const roleClass = (()=>{
        const role = (d.role||'').toLowerCase();
        if(['friendly','defense','offense'].includes(role)) return 'friendly';
        if(['hostile','attack','enemy'].includes(role)) return 'hostile';
        return '';
      })();
      const statusLabel = (d.status || 'ACTIVE').toString().toUpperCase();

      return `<div class="track-card">
        <header>
          <div class="track-id">${d.id}</div>
          <div class="track-role ${roleClass}">${roleLabel}</div>
        </header>
        <div class="track-coords">üìç ${lat}, ${lon}</div>
        <div class="track-metrics">
          <div><span>Status</span><strong>${statusLabel}</strong></div>
          <div><span>Velocity</span><strong>${velocity}</strong></div>
          <div><span>Altitude</span><strong>${altitude}</strong></div>
          <div><span>Signal</span><strong>${signal}</strong></div>
          <div><span>Battery</span><strong>${battery}</strong></div>
          <div><span>Last Update</span><strong>${d.ts ? fmtLogTime(d.ts) : '--:--:--'}</strong></div>
        </div>
        <div class="track-actions">
          <button class="btn secondary" style="padding:6px 12px;font-size:11px" onclick="trackDrone('${d.id}')">Track</button>
        </div>
      </div>`;
    }).join('') || '<div style="color:#64748b;font-size:12px;text-align:center;padding:24px 12px;">No priority tracks available.</div>';
  }

  if(eventLogEl){
    const logEvents = [];

    detections.forEach(d => {
      const confValue = Number.isFinite(Number(d.confidence))
        ? `${Number(d.confidence).toFixed(0)}%`
        : '‚Äî';
      logEvents.push({
        ts: d.ts,
        severity: (d.raw_type||'').toLowerCase().includes('hostile') ? 'critical'
                  : (d.raw_type||'').toLowerCase().includes('friendly') ? 'success' : 'info',
        message: `New ${(d.raw_type || 'target').replace(/_/g,' ')} detected. Confidence: ${confValue}`
      });
    });

    drones.forEach(d => {
      if(!d.ts) return;
      logEvents.push({
        ts: d.ts,
        severity: d.role === 'friendly' ? 'success' : 'info',
        message: `${d.id} changed status to ${ (d.status || 'ACTIVE').toString().toUpperCase() }.`
      });
    });

    if(window._ackLogEntry){
      logEvents.push(window._ackLogEntry);
    }

    const logHtml = logEvents
      .filter(e => e.ts)
      .sort((a,b)=>new Date(b.ts).getTime() - new Date(a.ts).getTime())
      .slice(0,8)
      .map(e => {
        const timeStr = fmtLogTime(e.ts);
        return `<div class="log-entry ${e.severity}"><div class="log-time">[${timeStr}]</div><div class="log-msg">${e.message}</div></div>`;
      })
      .join('');

    eventLogEl.innerHTML = logHtml || '<div style="color:#475569;text-align:center;padding:16px 0">No events logged.</div>';
  }

  // Map
  detLayer.clearLayers();
  routeLineLayer.clearLayers();
  arrowLayer.clearLayers();

  // detections: ‡πÇ‡∏ä‡∏ß‡πå 10 ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠
  const detsToDraw = detections.slice(0,10);
  detsToDraw.forEach(d=>{
    L.circleMarker([d.lat,d.lon],{
      radius:6,
      color:'#ef4444',
      fillColor:'#ef4444',
      fillOpacity:.5,
      weight:1
    })
    .bindTooltip(
      `${d.raw_type||'unknown'} ‚Ä¢ ${d.source_id||''}\nconf ${d.confidence ?? '-'}\n${fmtTime(d.ts)}`
    )
    .addTo(detLayer);
  });

  // routes: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡πÇ‡∏î‡∏£‡∏ô ‡πÅ‡∏ï‡πà‡∏™‡∏µ/‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏° role
  byId.forEach((arr,id)=>{
    const sorted = arr.slice().sort((a,b)=>(a.seq||0)-(b.seq||0));
    const coords = sorted.map(p=>[p.lat,p.lon]);
    const last = sorted[sorted.length - 1];
    const role = last?.role || getRole(id, arr) || 'friendly';

    const col = role === 'attack' || role === 'hostile'
      ? '#ff6699'
      : '#34d399';

    // draw main route
    if(coords.length>=2) {
      L.polyline(coords,{
        color:col,
        weight:3,
        opacity:.95
      }).addTo(routeLineLayer);

      // tail effect (‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö attack)
      for(let i = Math.max(0, sorted.length - 5); i < sorted.length; i++){
        const opacity = 0.25 + (i / Math.max(1, sorted.length)) * 0.5;
        const weight = 2 + (i / Math.max(1, sorted.length)) * 1;
        if(i < sorted.length - 1){
          L.polyline(
            [coords[i], coords[i+1]],
            {
              color:col,
              weight:weight,
              opacity:opacity,
              dashArray: role==='attack' ? '2,6' : '5,5'
            }
          ).addTo(routeLineLayer);
        }
      }
    }

    // show drone icon at last point
    if(sorted.length >= 1 && last){
      let angle = 0;
      if(sorted.length >= 2){
        const prev = sorted[sorted.length - 2];
        angle = (Math.atan2(last.lon - prev.lon, last.lat - prev.lat) * 180 / Math.PI) || 0;
      }

      const droneSvg = `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
        <rect x="17" y="12" width="6" height="16" fill="${col}" rx="2" opacity="0.95"/>
        <rect x="2" y="17" width="15" height="3" fill="${col}" rx="1.5"/>
        <rect x="23" y="17" width="15" height="3" fill="${col}" rx="1.5"/>
        <circle cx="20" cy="12" r="2" fill="${col}"/>
      </svg>`;

      const droneIcon = L.divIcon({
        html: `<div class="drone-float" style="transform: rotate(${angle}deg); display:flex; align-items:center; justify-content:center">${droneSvg}</div>`,
        className: 'drone-icon',
        iconSize: [40, 40],
        iconAnchor: [20, 20]
      });

      const marker = L.marker([last.lat,last.lon],{icon:droneIcon}).addTo(arrowLayer);
      marker.bindTooltip(
        `${id}\n${String(role).toUpperCase()}\nseq ${last.seq ?? '0'}`,
        {permanent:true, direction:'top', offset:[0,-20], className:'drone-label'}
      ).openTooltip();
    }
  });

  // map maintains fixed zoom view (no auto-fit)
}

/* ===================== WS with BACKOFF ===================== */
function setWsUI(s){
  const lamp=document.getElementById('wsLamp');
  const t=document.getElementById('wsState');
  lamp.classList.remove('connected','connecting','error','on','err');
  if(s==='OPEN'){
    lamp.classList.add('connected');
    t.textContent='CONNECTED';
  } else if(s==='ERROR'){
    lamp.classList.add('error');
    t.textContent='ERROR';
  } else if(s==='CONNECTING'){
    lamp.classList.add('connecting');
    t.textContent='CONNECTING...';
  } else {
    t.textContent='DISCONNECTED';
  }
}

let retry=0, ws=null, hb=null;

function handleMsg(m){
  const t=m?.type, d=m?.data;
  if(t==='detection'&&d) pushDet(d);
  else if(t==='detections'&&Array.isArray(d)) d.forEach(pushDet);
  else if(t==='route_point'&&d) pushRoute(d);
  else if(t==='route_batch'&&Array.isArray(d)) d.forEach(pushRoute);
  else if(t==='clear'){
    const s=m.scope||'all';
    if(s==='detections'||s==='all') detections=[];
    if(s==='routes'||s==='all') routes=[];
  }
  keepRecentDetections(10);
  saveState();
  redraw();
}

function openWs(url){
  setWsUI('CONNECTING');
  ws = new WebSocket(url);
  ws.onopen=()=>{
    retry=0;
    setWsUI('OPEN');
    if(hb) clearInterval(hb);
    hb=setInterval(()=>{
      try{ws.send('{"type":"ping"}');}catch{}
    },8000);
  };
  ws.onerror=()=> setWsUI('ERROR');
  ws.onclose=()=>{
    setWsUI('DISCONNECTED');
    const wait=Math.min(15000, 1000*(2**(++retry)));
    setTimeout(()=>openWs(url), wait);
  };
  ws.onmessage=(ev)=>{
    try{ handleMsg(JSON.parse(ev.data)); }
    catch{}
  };
}

const ackBtn = document.getElementById('ackAlertBtn');
if(ackBtn){
  ackBtn.addEventListener('click', ()=>{
    window._ackLogEntry = {
      ts: new Date().toISOString(),
      severity: 'info',
      message: 'Alert acknowledged by operator.'
    };
    ackBtn.textContent = 'ALERT ACKNOWLEDGED';
    ackBtn.disabled = true;
    ackBtn.style.opacity = '0.75';
    redraw();
  });
}

openWs(wsURL);
redraw();
</script>
</body>
</html>
